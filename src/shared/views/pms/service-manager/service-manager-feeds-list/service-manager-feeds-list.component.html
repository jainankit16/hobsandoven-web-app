<div class="row">
	<div class="col-md-12 text-center">
		<div class="headermsg">
			<h3>Service Manager (Dispatch FSE) - Activity Feed Console (PMS)</h3>
		</div>
	</div>
</div>
<div class="card">
	<div class="card-body">
		<!--Filter Div-->
		<div class="row">
			<div class="col-md-12 text-center">
				<service-manager-filters page="Feed" (filterDataList)='filterDataList($event)'></service-manager-filters>
			</div>
		</div>
		<!---End-->
		<!--For Edit Columns and Refresh div-->
		<div class="row m-t-10">
			<div class="col-12 text-right">
				<button type="button" class="btn btn-sm mRight editColumn" i18n>
					<i class="fa fa-th"></i> Edit Columns
				</button>
				<div class="dd-column-selector">
					<li *ngFor='let col of allColumns' class="p-l-5">
						<input *ngIf="col.name !=''" type='checkbox' [id]="col.name" (click)='toggle(col)' [checked]='col.visible' />
						<label *ngIf="col.name !=''" [attr.for]="col.name">{{col.name}}</label>
					</li>
				</div>
				<button type="button" class="btn btn-sm mRight" (click)="refreshView();" i18n>
					<i class="fa fa-refresh"></i> Refresh
				</button>
				<button *ngIf="tableData[0] && !tableData[0]['message']" class="btn btn-sm" (click)="exportCSV()">
					<i class="fa fa-download"></i> CSV</button>
			</div>
		</div>
		<!--End-->
		<!--For NGX-datatable div-->
		<div id="dataTable" class="m-t-5 form-material">

			<ngx-datatable #myTable class="material striped fixed-header expandable" [ngClass]="(tableData[0] && !tableData[0]['message'])  ? 'doubleScroll' : 'singleScroll'"
			 [rows]="tableData" [loadingIndicator]="loadingIndicator" [columnMode]="'standard'" [limit]="itemsPerPage" [headerHeight]="110"
			 [footerHeight]="50" [rowHeight]="60" ngx-resize-watcher>
				<div *ngFor="let col of columns">

					<ngx-datatable-column *ngIf="col.visible" [name]="col.name" [prop]="col.prop" [width]="col.width" [sortable]="col.sortable">

						<ng-template *ngIf="col.name == 'Action'" let-row="row" let-expanded="expanded" ngx-datatable-cell-template>
							<a *ngIf="tableData[0] && !tableData[0]['message']" href="javascript:void(0)" title="Expand/Collapse Row" (click)="toggleExpandRow(row)">
								<i *ngIf="!expanded" class="mdi mdi-plus icon-size"></i>
								<i *ngIf="expanded" class="mdi mdi-minus icon-size"></i>
							</a>
							<a *ngIf="tableData[0] && !tableData[0]['message']" href="javascript:;" (click)="openMessageTab(row.id)" style="float: right !important;">
								<i class="mdi mdi-message-text icon-size"></i>
							</a>
						</ng-template>

						<ng-template *ngIf="col.name != 'Action'" let-column="column" let-sort="sortFn" ngx-datatable-header-template>
							<span class="datatable-header-cell-wrapper float-left">
								<span class="datatable-header-cell-label draggable" (click)="sort()">
									{{col.name}}
								</span>
							</span>
							<div class="input-group float-right form-material" *ngIf="col.type !='date'">
								<input type="text" class="form-control t-search-tb" [id]="col.prop" placeholder="Type to search..." name="col.prop" [(ngModel)]="filterObj[col.prop]"
								 (keyup)='filterData($event,"text")' [ngModelOptions]="{standalone: true}">
								<span class="input-group-btn">
									<a class="dataTable-cross" (click)="clearSearch(col.prop);" href="javascript:void(0);">
										<i class="fa fa-times suffex"></i>
									</a>
								</span>
							</div>
							<div class="input-group float-right form-material" *ngIf="col.type =='date'">
								<input [owlDateTimeTrigger]="dt" class="form-control t-search-tb" placeholder="Select to search..." [id]="col.prop" [owlDateTime]="dt"
								 (dateTimeChange)='filterData($event,"date")' readonly="true" [(ngModel)]="col.value" [ngModelOptions]="{standalone: true}">
								<owl-date-time #dt [pickerType]="'calendar'"></owl-date-time>
								<span class="input-group-btn">
									<a class="dataTable-cross" (click)="clearSearch(col.prop); col.value='';" href="javascript:void(0);">
										<i class="fa fa-times suffex"></i>
									</a>
								</span>
							</div>
						</ng-template>

						<ng-template *ngIf="col.prop == 'CaseNumber'" let-row="row" ngx-datatable-cell-template>
							<a href="javascript:void(0);" *ngIf="row.sfdcId" (click)="redirectToDetails(row.id)">
								<span class="job-title">{{row.CaseNumber}}</span>
							</a>
							<span *ngIf="tableData[0]['message']">{{row.CaseNumber}}</span>
						</ng-template>

						<ng-template *ngIf="isInternalUser && col.prop == 'Name'" let-row="row" ngx-datatable-cell-template>
							<a href="javascript:void(0);" *ngIf="row.sfdcId">
								<span class="job-title">{{row.Name}}</span>
							</a>
						</ng-template>

						<ng-template *ngIf="isInternalUser && col.prop == 'CaCaseNumber'" let-row="row" ngx-datatable-cell-template>
							<a href="javascript:void(0);" *ngIf="row.sfdcId" (click)="redirectToDetails(row.id)">
								<span class="job-title">{{row.CaCaseNumber}}</span>
							</a>

						</ng-template>

						<ng-template *ngIf="isInternalUser && col.prop == 'Iron_Job_num__c'" let-row="row" ngx-datatable-cell-template>
							<span>{{row.Iron_Job_num__c}}</span>
						</ng-template>

						<ng-template *ngIf="col.prop == 'programName'" let-row="row" ngx-datatable-cell-template>
							<span #pName [ngClass]="{'hidepanel': pName.value}">{{ row?.programName ? (row?.programName | slice:0:30) : ''}}</span>
							<span [ngClass]="{'hidepanel': !pName.value}" (click)="pName.value = ! pName.value">{{row?.programName}}</span>
							<a *ngIf="row?.programName && row?.programName.length>30" class="a-link" (click)="pName.value = ! pName.value" href="javaScript:void(0)">
								{{ pName.value? '&laquo;..' : '...&raquo;' }}</a>
						</ng-template>

						<ng-template *ngIf="col.prop == 'JobsiteName'" let-row="row" ngx-datatable-cell-template>
							<span #jName [ngClass]="{'hidepanel': jName.value}">{{ row?.JobsiteName ? (row?.JobsiteName | slice:0:30) : ''}}</span>
							<span [ngClass]="{'hidepanel': !jName.value}" (click)="jName.value = ! jName.value">{{row?.JobsiteName}}</span>
							<a *ngIf="row?.JobsiteName && row?.JobsiteName.length>30" class="a-link" (click)="jName.value = ! jName.value" href="javaScript:void(0)">
								{{ jName.value? '&laquo;..' : '...&raquo;' }}</a>
						</ng-template>

						<ng-template *ngIf="col.prop == 'Case_Summary__c'" let-row="row" ngx-datatable-cell-template>
							<span #summary [ngClass]="{'hidepanel': summary.value}">{{ row?.Case_Summary__c ? (row?.Case_Summary__c | slice:0:30) : ''}}</span>
							<span [ngClass]="{'hidepanel': !summary.value}" (click)="summary.value = ! summary.value">{{row?.Case_Summary__c}}</span>
							<a *ngIf="row?.Case_Summary__c && row?.Case_Summary__c.length>30" class="a-link" (click)="summary.value = ! summary.value"
							 href="javaScript:void(0)">
								{{ summary.value? '&laquo;..' : '...&raquo;' }}</a>
						</ng-template>

						<ng-template *ngIf="isInternalUser && col.prop == 'MessagesMSPInternalCase'" let-row="row" ngx-datatable-cell-template>
							<span>{{row.MessagesMSPInternalCase}}</span>
						</ng-template>
						<ng-template *ngIf="isInternalUser && col.prop == 'Messages3PSCase'" let-row="row" ngx-datatable-cell-template>
							<span>{{row.Messages3PSCase}}</span>
						</ng-template>
						<ng-template *ngIf="isInternalUser && col.prop == 'Messages3PLCase'" let-row="row" ngx-datatable-cell-template>
							<span>{{row.Messages3PLCase}}</span>
						</ng-template>
						<ng-template *ngIf="isInternalUser && col.prop == 'MessagesWorkerCase'" let-row="row" ngx-datatable-cell-template>
							<span>{{row.MessagesWorkerCase}}</span>
						</ng-template>
						<ng-template *ngIf="isInternalUser && col.prop == 'DateUpdateICCCase'" let-row="row" ngx-datatable-cell-template>
							<span>{{row.DateUpdateICCCase}}</span>
						</ng-template>

						<ngx-datatable-row-detail [rowHeight]="'auto'" #myDetailRow>
							<ng-template let-row="row" let-expanded="expanded" ngx-datatable-row-detail-template>
								<div class="expand-row">
									<div class="row">
										<div class="col-md-3">Case Number: {{row?.CaseNumberDetail}}</div>
										<div class="col-md-3">Account Name : {{row?.partnerName}}</div>
										<div class="col-md-3">Status: {{row?.workOrderStatus__c}}</div>
										<div class="col-md-3">Case Origin: {{row?.Origin}}</div>
									</div>
									<br/>
									<div class="row">
										<div class="col-md-3">PMS Case Summary : {{row?.Case_Summary__c}}</div>
										<div class="col-md-3">Case Subject : {{row?.Subject}} </div>
										<div class="col-md-3">IRON PMS Case Number : {{row?.Iron_Case_Number__c}}</div>
										<div class="col-md-3">Program : {{row?.programName}}</div>
									</div>
									<br/>
									<div class="row">
										<div class="col-md-3">Partner Case Number : {{row?.workOrderPartner_PO_Number__c}}</div>
										<div class="col-md-3">Case RecordType : {{row?.RecordTypeName}}</div>
									</div>
								</div>
							</ng-template>
						</ngx-datatable-row-detail>

					</ngx-datatable-column>
				</div>
				<ngx-datatable-footer>
					<ng-template ngx-datatable-footer-template let-rowCount="rowCount" let-pageSize="pageSize" let-selectedCount="selectedCount"
					 let-curPage="curPage" let-offset="offset">
						<div style="padding: 5px 10px">
							<div>
								Total: {{((tableData[0]) && !tableData[0]['message']) ? rowCount : 0}}
							</div>
						</div>
						<datatable-pager [pagerLeftArrowIcon]="'datatable-icon-left'" [pagerRightArrowIcon]="'datatable-icon-right'" [pagerPreviousIcon]="'datatable-icon-prev'"
						 [pagerNextIcon]="'datatable-icon-skip'" [page]="curPage" [size]="pageSize" [count]="rowCount" [hidden]="!((rowCount / pageSize) > 1)"
						 (change)="myTable.onFooterPage($event)">
						</datatable-pager>
						<div style="padding: 5px 10px" class="ml-auto" *ngIf="moreRecords">
							<div>
								<button type="button" class="btn btn-sm" (click)="loadMoreRecords()">Load More</button>
							</div>
						</div>
					</ng-template>
				</ngx-datatable-footer>
			</ngx-datatable>


		</div>
		<!--End-->
	</div>
</div>